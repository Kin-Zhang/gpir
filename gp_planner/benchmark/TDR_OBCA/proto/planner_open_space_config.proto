syntax = "proto2";

package apollo.planning;

//////////////////////////////////////////////////////////////////////

enum VehicleBrand {
  LINCOLN_MKZ = 0;
  GEM = 1;
  LEXUS = 2;
  TRANSIT = 3;
  GE3 = 4;
  WEY = 5;
  ZHONGYUN = 6;
  CH = 7;
  DKIT = 8;
  NEOLIX = 9;
}

message VehicleID {
  optional string vin = 1;
  optional string plate = 2;
  optional string other_unique_id = 3;
}

message LatencyParam {
  // latency parameters, in second (s)
  optional double dead_time = 1;
  optional double rise_time = 2;
  optional double peak_time = 3;
  optional double settling_time = 4;
}

message VehicleParam {
  optional VehicleBrand brand = 1;
  // Car center point is car reference point, i.e., center of rear axle.
  optional VehicleID vehicle_id = 2;
  optional double front_edge_to_center = 3 [default = nan];
  optional double back_edge_to_center = 4 [default = nan];
  optional double left_edge_to_center = 5 [default = nan];
  optional double right_edge_to_center = 6 [default = nan];

  optional double length = 7 [default = nan];
  optional double width = 8 [default = nan];
  optional double height = 9 [default = nan];

  optional double min_turn_radius = 10 [default = nan];
  optional double max_acceleration = 11 [default = nan];
  optional double max_deceleration = 12 [default = nan];

  // The following items are used to compute trajectory constraints in
  // planning/control/canbus,
  // vehicle max steer angle
  optional double max_steer_angle = 13 [default = nan];
  // vehicle max steer rate; how fast can the steering wheel turn.
  optional double max_steer_angle_rate = 14 [default = nan];
  // vehicle min steer rate;
  optional double min_steer_angle_rate = 15 [default = nan];
  // ratio between the turn of steering wheel and the turn of wheels
  optional double steer_ratio = 16 [default = nan];
  // the distance between the front and back wheels
  optional double wheel_base = 17 [default = nan];
  // Tire effective rolling radius (vertical distance between the wheel center
  // and the ground).
  optional double wheel_rolling_radius = 18 [default = nan];

  // minimum differentiable vehicle speed, in m/s
  optional float max_abs_speed_when_stopped = 19 [default = nan];

  // minimum value get from chassis.brake, in percentage
  optional double brake_deadzone = 20 [default = nan];
  // minimum value get from chassis.throttle, in percentage
  optional double throttle_deadzone = 21 [default = nan];

  // vehicle latency parameters
  optional LatencyParam steering_latency_param = 22;
  optional LatencyParam throttle_latency_param = 23;
  optional LatencyParam brake_latency_param = 24;
}

//////////////////////////////////////////////////////////////////////

message PiecewiseJerkSpeedOptimizerConfig {
  optional double acc_weight = 1 [default = 1.0];
  optional double jerk_weight = 2 [default = 10.0];
  optional double kappa_penalty_weight = 3 [default = 1000.0];
  optional double ref_s_weight = 4 [default = 10.0];
  optional double ref_v_weight = 5 [default = 10.0];
}


message FemPosDeviationSmootherConfig {
  optional double weight_fem_pos_deviation = 2 [default = 1.0e10];
  optional double weight_ref_deviation = 3 [default = 1.0];
  optional double weight_path_length = 4 [default = 1.0];
  optional bool apply_curvature_constraint = 5 [default = false];
  optional double weight_curvature_constraint_slack_var = 6 [default = 1.0e2];
  optional double curvature_constraint = 7 [default = 0.2];
  optional bool use_sqp = 8 [default = false];
  optional double sqp_ftol = 9 [default = 1e-4];
  optional double sqp_ctol = 10 [default = 1e-3];
  optional int32 sqp_pen_max_iter = 11 [default = 10];
  optional int32 sqp_sub_max_iter = 12 [default = 100];

  // osqp settings
  optional int32 max_iter = 100 [default = 500];
  // time_limit set to be 0.0 meaning no time limit
  optional double time_limit = 101 [default = 0.0];
  optional bool verbose = 102 [default = false];
  optional bool scaled_termination = 103 [default = true];
  optional bool warm_start = 104 [default = true];

  // ipopt settings
  optional int32 print_level = 200 [default = 0];
  optional int32 max_num_of_iterations = 201 [default = 500];
  optional int32 acceptable_num_of_iterations = 202 [default = 15];
  optional double tol = 203 [default = 1e-8];
  optional double acceptable_tol = 204 [default = 1e-1];
}

//////////////////////////////////////////////////////////////////////

enum DualWarmUpMode {
  IPOPT = 0;
  IPOPTQP = 1;
  OSQP = 2;
  DEBUG = 3;
  SLACKQP = 4;
}

enum DistanceApproachMode {
  DISTANCE_APPROACH_IPOPT = 0;
  DISTANCE_APPROACH_IPOPT_CUDA = 1;
  DISTANCE_APPROACH_IPOPT_FIXED_TS = 2;
  DISTANCE_APPROACH_IPOPT_FIXED_DUAL = 3;
  DISTANCE_APPROACH_IPOPT_RELAX_END = 4;
  DISTANCE_APPROACH_IPOPT_RELAX_END_SLACK = 5;
}

message PlannerOpenSpaceConfig {
  // Open Space ROIConfig
  optional ROIConfig roi_config = 1;
  // Hybrid A Star Warm Start
  optional WarmStartConfig warm_start_config = 2;
  // Dual Variable Warm Start
  optional DualVariableWarmStartConfig dual_variable_warm_start_config = 3;
  // Distance Approach Configs
  optional DistanceApproachConfig distance_approach_config = 4;
  // Iterative Anchoring Configs
  optional IterativeAnchoringConfig iterative_anchoring_smoother_config = 5;
  // Trajectory PartitionConfig Configs
  optional TrajectoryPartitionConfig trajectory_partition_config = 6;
  optional float delta_t = 7 [default = 1.0];
  optional double is_near_destination_threshold = 8 [default = 0.001];
  optional bool enable_check_parallel_trajectory = 9 [default = false];
  optional bool enable_linear_interpolation = 10 [default = false];
  optional double is_near_destination_theta_threshold = 11 [default = 0.05];
}

message ROIConfig {
  // longitudinal range of parking roi backward
  optional double roi_longitudinal_range_start = 1 [default = 10.0];
  // longitudinal range of parking roi forward
  optional double roi_longitudinal_range_end = 2 [default = 10.0];
  // parking spot range detection threshold
  optional double parking_start_range = 3 [default = 7.0];
  // Parking orientation for reverse parking
  optional bool parking_inwards = 4 [default = false];
}

message WarmStartConfig {
  // Hybrid a star for warm start
  optional double xy_grid_resolution = 1 [default = 0.2];
  optional double phi_grid_resolution = 2 [default = 0.05];
  optional uint64 next_node_num = 3 [default = 10];
  optional double step_size = 4 [default = 0.5];
  optional double traj_forward_penalty = 5 [default = 0.0];
  optional double traj_back_penalty = 6 [default = 0.0];
  optional double traj_gear_switch_penalty = 7 [default = 10.0];
  optional double traj_steer_penalty = 8 [default = 100.0];
  optional double traj_steer_change_penalty = 9 [default = 10.0];
  // Grid a star for heuristic
  optional double grid_a_star_xy_resolution = 15 [default = 0.1];
  optional double node_radius = 16 [default = 0.5];
  optional PiecewiseJerkSpeedOptimizerConfig s_curve_config = 17;
}

message DualVariableWarmStartConfig {
  // Dual variable Warm Start
  optional double weight_d = 1 [default = 1.0];
  optional IpoptConfig ipopt_config = 2;
  optional DualWarmUpMode qp_format = 3;
  optional double min_safety_distance = 4 [default = 0.0];
  optional bool debug_osqp = 5 [default = false];
  optional double beta = 6 [default = 1.0];
  optional OSQPConfig osqp_config = 7;
}

message DistanceApproachConfig {
  // Distance approach weight configs
  optional double weight_steer = 1;
  optional double weight_a = 2;
  optional double weight_steer_rate = 3;
  optional double weight_a_rate = 4;
  optional double weight_x = 5;
  optional double weight_y = 6;
  optional double weight_phi = 7;
  optional double weight_v = 8;
  optional double weight_steer_stitching = 9;
  optional double weight_a_stitching = 10;
  optional double weight_first_order_time = 11;
  optional double weight_second_order_time = 12;
  optional double min_safety_distance = 13 [default = 0.0];
  optional double max_speed_forward = 14 [default = 3.0];
  optional double max_speed_reverse = 15 [default = 2.0];
  optional double max_acceleration_forward = 16 [default = 2.0];
  optional double max_acceleration_reverse = 17 [default = 2.0];
  optional double min_time_sample_scaling = 18 [default = 0.1];
  optional double max_time_sample_scaling = 19 [default = 10.0];
  optional bool use_fix_time = 20 [default = false];
  optional IpoptConfig ipopt_config = 21;
  optional bool enable_constraint_check = 22;
  optional bool enable_hand_derivative = 23;
  // True to enable hand derived derivative inside open space planner
  optional bool enable_derivative_check = 24;
  // True to enable derivative check inside open space planner
  optional bool enable_initial_final_check = 25 [default = false];
  optional DistanceApproachMode distance_approach_mode = 26;
  optional bool enable_jacobian_ad = 27 [default = false];
  optional bool enable_check_initial_state = 28 [default = false];
  optional double weight_end_state = 29 [default = 0.0];
  optional double weight_slack = 30 [default = 0.0];
}

message IpoptConfig {
  // Ipopt configs
  optional int32 ipopt_print_level = 1;
  optional int32 mumps_mem_percent = 2;
  optional double mumps_pivtol = 3;
  optional int32 ipopt_max_iter = 4;
  optional double ipopt_tol = 5;
  optional double ipopt_acceptable_constr_viol_tol = 6;
  optional double ipopt_min_hessian_perturbation = 7;
  optional double ipopt_jacobian_regularization_value = 8;
  optional string ipopt_print_timing_statistics = 9;
  optional string ipopt_alpha_for_y = 10;
  optional string ipopt_recalc_y = 11;
  optional double ipopt_mu_init = 12 [default = 0.1];
  // ipopt barrier parameter, default 0.1
}

// Dual variable configs for OSQP
message OSQPConfig {
  optional double alpha = 1 [default = 1.0];
  optional double eps_abs = 2 [default = 1.0e-3];
  optional double eps_rel = 3 [default = 1.0e-3];
  optional int32 max_iter = 4 [default = 10000];
  optional bool polish = 5 [default = true];
  optional bool osqp_debug_log = 6 [default = false];
}

message IterativeAnchoringConfig {
  // Ipopt configs
  optional double interpolated_delta_s = 1 [default = 0.1];
  optional int32 reanchoring_trails_num = 2 [default = 50];
  optional double reanchoring_pos_stddev = 3 [default = 0.25];
  optional double reanchoring_length_stddev = 4 [default = 1.0];
  optional bool estimate_bound = 5 [default = false];
  optional double default_bound = 6 [default = 2.0];
  optional double vehicle_shortest_dimension = 7 [default = 1.04];
  optional FemPosDeviationSmootherConfig fem_pos_deviation_smoother_config = 8;
  optional double collision_decrease_ratio = 9 [default = 0.9];
  // TODO(QiL, Jinyun): Merge following with overall config for open space
  optional double max_forward_v = 10 [default = 2.0];
  optional double max_reverse_v = 11 [default = 2.0];
  optional double max_forward_acc = 12 [default = 3.0];
  optional double max_reverse_acc = 13 [default = 2.0];
  optional double max_acc_jerk = 14 [default = 4.0];
  optional double delta_t = 15 [default = 0.2];
  optional PiecewiseJerkSpeedOptimizerConfig s_curve_config = 16;
}

message TrajectoryPartitionConfig {
  optional uint64 interpolated_pieces_num = 1 [default = 50];
  optional uint64 initial_gear_check_horizon = 2 [default = 3];
  optional double heading_searching_range = 3 [default = 0.3];
  optional double gear_shift_period_duration = 4 [default = 2.0];
  optional double gear_shift_max_t = 5 [default = 3.0];
  optional double gear_shift_unit_t = 6 [default = 0.02];
}
